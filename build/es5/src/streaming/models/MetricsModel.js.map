{"version":3,"sources":["../../../../../src/streaming/models/MetricsModel.js"],"names":["Constants","MetricsConstants","MetricsList","HTTPRequest","HTTPRequestTrace","TrackSwitch","BufferLevel","BufferState","DVRInfo","DroppedFrames","ManifestUpdate","ManifestUpdateStreamInfo","ManifestUpdateRepresentationInfo","SchedulingInfo","EventBus","RequestsQueue","Events","FactoryMaker","MetricsModel","MAXIMUM_LIST_DEPTH","context","eventBus","getInstance","instance","streamMetrics","setup","metricsChanged","trigger","METRICS_CHANGED","metricChanged","mediaType","METRIC_CHANGED","metricUpdated","metricType","vo","METRIC_UPDATED","metric","value","metricAdded","METRIC_ADDED","clearCurrentMetricsForType","type","clearAllCurrentMetrics","getReadOnlyMetricsFor","hasOwnProperty","getMetricsFor","metrics","pushMetrics","list","push","length","shift","appendHttpTrace","httpRequest","s","d","b","trace","interval","addHttpRequest","tcpid","url","actualurl","serviceLocation","range","trequest","tresponse","tfinish","responsecode","mediaduration","responseHeaders","traces","_tfinish","_stream","_mediaduration","_responseHeaders","_serviceLocation","forEach","pushAndNotify","HTTP_REQUEST","addRepresentationSwitch","t","mt","to","lto","TRACK_SWITCH","metricObject","addBufferLevel","level","BUFFER_LEVEL","addBufferState","state","target","BUFFER_STATE","addDVRInfo","currentTime","mpd","time","manifestInfo","DVR_INFO","addDroppedFrames","quality","creationTime","droppedFrames","droppedVideoFrames","DROPPED_FRAMES","addSchedulingInfo","startTime","availabilityStartTime","duration","SCHEDULING_INFO","addRequestsQueue","loadingRequests","executedRequests","REQUESTS_QUEUE","addManifestUpdate","requestTime","fetchTime","presentationStartTime","clientTimeOffset","buffered","latency","STREAM","MANIFEST_UPDATE","updateManifestUpdateInfo","manifestUpdate","updatedFields","field","addManifestUpdateStreamInfo","id","index","start","streamInfo","MANIFEST_UPDATE_STREAM_INFO","addManifestUpdateRepresentationInfo","streamIndex","presentationTimeOffset","startNumber","fragmentInfoType","representationInfo","MANIFEST_UPDATE_TRACK_INFO","addPlayList","Array","isArray","subreplevel","PLAY_LIST","addDVBErrors","DVB_ERRORS","__dashjs_factory_name","getSingletonFactory"],"mappings":"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","file":"MetricsModel.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\nimport Constants from '../constants/Constants';\r\nimport MetricsConstants from '../constants/MetricsConstants';\r\nimport MetricsList from '../vo/MetricsList';\r\nimport {HTTPRequest, HTTPRequestTrace} from '../vo/metrics/HTTPRequest';\r\nimport TrackSwitch from '../vo/metrics/RepresentationSwitch';\r\nimport BufferLevel from '../vo/metrics/BufferLevel';\r\nimport BufferState from '../vo/metrics/BufferState';\r\nimport DVRInfo from '../vo/metrics/DVRInfo';\r\nimport DroppedFrames from '../vo/metrics/DroppedFrames';\r\nimport {ManifestUpdate, ManifestUpdateStreamInfo, ManifestUpdateRepresentationInfo} from '../vo/metrics/ManifestUpdate';\r\nimport SchedulingInfo from '../vo/metrics/SchedulingInfo';\r\nimport EventBus from '../../core/EventBus';\r\nimport RequestsQueue from '../vo/metrics/RequestsQueue';\r\nimport Events from '../../core/events/Events';\r\nimport FactoryMaker from '../../core/FactoryMaker';\r\n\r\nfunction MetricsModel() {\r\n\r\n    const MAXIMUM_LIST_DEPTH = 1000;\r\n\r\n    let context = this.context;\r\n    let eventBus = EventBus(context).getInstance();\r\n\r\n    let instance,\r\n        streamMetrics;\r\n\r\n    function setup() {\r\n        streamMetrics = {};\r\n    }\r\n\r\n    function metricsChanged() {\r\n        eventBus.trigger(Events.METRICS_CHANGED);\r\n    }\r\n\r\n    function metricChanged(mediaType) {\r\n        eventBus.trigger(Events.METRIC_CHANGED, {mediaType: mediaType});\r\n        metricsChanged();\r\n    }\r\n\r\n    function metricUpdated(mediaType, metricType, vo) {\r\n        eventBus.trigger(Events.METRIC_UPDATED, {mediaType: mediaType, metric: metricType, value: vo});\r\n        metricChanged(mediaType);\r\n    }\r\n\r\n    function metricAdded(mediaType, metricType, vo) {\r\n        eventBus.trigger(Events.METRIC_ADDED, {mediaType: mediaType, metric: metricType, value: vo});\r\n        metricChanged(mediaType);\r\n    }\r\n\r\n    function clearCurrentMetricsForType(type) {\r\n        delete streamMetrics[type];\r\n        metricChanged(type);\r\n    }\r\n\r\n    function clearAllCurrentMetrics() {\r\n        streamMetrics = {};\r\n        metricsChanged();\r\n    }\r\n\r\n    function getReadOnlyMetricsFor(type) {\r\n        if (streamMetrics.hasOwnProperty(type)) {\r\n            return streamMetrics[type];\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    function getMetricsFor(type) {\r\n        let metrics;\r\n\r\n        if (streamMetrics.hasOwnProperty(type)) {\r\n            metrics = streamMetrics[type];\r\n        } else {\r\n            metrics = new MetricsList();\r\n            streamMetrics[type] = metrics;\r\n        }\r\n\r\n        return metrics;\r\n    }\r\n\r\n    function pushMetrics(type, list, value) {\r\n        let metrics = getMetricsFor(type);\r\n        metrics[list].push(value);\r\n        if ( metrics[list].length > MAXIMUM_LIST_DEPTH ) {\r\n            metrics[list].shift();\r\n        }\r\n    }\r\n\r\n    function appendHttpTrace(httpRequest, s, d, b) {\r\n        let vo = new HTTPRequestTrace();\r\n\r\n        vo.s = s;\r\n        vo.d = d;\r\n        vo.b = b;\r\n\r\n        httpRequest.trace.push(vo);\r\n\r\n        if (!httpRequest.interval) {\r\n            httpRequest.interval = 0;\r\n        }\r\n\r\n        httpRequest.interval += d;\r\n\r\n        return vo;\r\n    }\r\n\r\n    function addHttpRequest(mediaType, tcpid, type, url, actualurl, serviceLocation, range, trequest, tresponse, tfinish, responsecode, mediaduration, responseHeaders, traces) {\r\n        let vo = new HTTPRequest();\r\n\r\n        // ISO 23009-1 D.4.3 NOTE 2:\r\n        // All entries for a given object will have the same URL and range\r\n        // and so can easily be correlated. If there were redirects or\r\n        // failures there will be one entry for each redirect/failure.\r\n        // The redirect-to URL or alternative url (where multiple have been\r\n        // provided in the MPD) will appear as the actualurl of the next\r\n        // entry with the same url value.\r\n        if (actualurl && (actualurl !== url)) {\r\n\r\n            // given the above, add an entry for the original request\r\n            addHttpRequest(\r\n                mediaType,\r\n                null,\r\n                type,\r\n                url,\r\n                null,\r\n                null,\r\n                range,\r\n                trequest,\r\n                null, // unknown\r\n                null, // unknown\r\n                null, // unknown, probably a 302\r\n                mediaduration,\r\n                null,\r\n                null\r\n            );\r\n\r\n            vo.actualurl = actualurl;\r\n        }\r\n\r\n        vo.tcpid = tcpid;\r\n        vo.type = type;\r\n        vo.url = url;\r\n        vo.range = range;\r\n        vo.trequest = trequest;\r\n        vo.tresponse = tresponse;\r\n        vo.responsecode = responsecode;\r\n\r\n        vo._tfinish = tfinish;\r\n        vo._stream = mediaType;\r\n        vo._mediaduration = mediaduration;\r\n        vo._responseHeaders = responseHeaders;\r\n        vo._serviceLocation = serviceLocation;\r\n\r\n        if (traces) {\r\n            traces.forEach(trace => {\r\n                appendHttpTrace(vo, trace.s, trace.d, trace.b);\r\n            });\r\n        } else {\r\n            // The interval and trace shall be absent for redirect and failure records.\r\n            delete vo.interval;\r\n            delete vo.trace;\r\n        }\r\n\r\n        pushAndNotify(mediaType, MetricsConstants.HTTP_REQUEST, vo);\r\n    }\r\n\r\n    function addRepresentationSwitch(mediaType, t, mt, to, lto) {\r\n        let vo = new TrackSwitch();\r\n\r\n        vo.t = t;\r\n        vo.mt = mt;\r\n        vo.to = to;\r\n\r\n        if (lto) {\r\n            vo.lto = lto;\r\n        } else {\r\n            delete vo.lto;\r\n        }\r\n\r\n        pushAndNotify(mediaType, MetricsConstants.TRACK_SWITCH, vo);\r\n    }\r\n\r\n    function pushAndNotify(mediaType, metricType, metricObject) {\r\n        pushMetrics(mediaType, metricType, metricObject);\r\n        metricAdded(mediaType, metricType, metricObject);\r\n    }\r\n\r\n    function addBufferLevel(mediaType, t, level) {\r\n        let vo = new BufferLevel();\r\n        vo.t = t;\r\n        vo.level = level;\r\n\r\n        pushAndNotify(mediaType, MetricsConstants.BUFFER_LEVEL, vo);\r\n    }\r\n\r\n    function addBufferState(mediaType, state, target) {\r\n        let vo = new BufferState();\r\n        vo.target = target;\r\n        vo.state = state;\r\n\r\n        pushAndNotify(mediaType, MetricsConstants.BUFFER_STATE, vo);\r\n    }\r\n\r\n    function addDVRInfo(mediaType, currentTime, mpd, range) {\r\n        let vo = new DVRInfo();\r\n        vo.time = currentTime ;\r\n        vo.range = range;\r\n        vo.manifestInfo = mpd;\r\n\r\n        pushAndNotify(mediaType, MetricsConstants.DVR_INFO, vo);\r\n    }\r\n\r\n    function addDroppedFrames(mediaType, quality) {\r\n        let vo = new DroppedFrames();\r\n        let list = getMetricsFor(mediaType).DroppedFrames;\r\n\r\n        vo.time = quality.creationTime;\r\n        vo.droppedFrames = quality.droppedVideoFrames;\r\n\r\n        if (list.length > 0 && list[list.length - 1] == vo) {\r\n            return;\r\n        }\r\n\r\n        pushAndNotify(mediaType, MetricsConstants.DROPPED_FRAMES, vo);\r\n    }\r\n\r\n    function addSchedulingInfo(mediaType, t, type, startTime, availabilityStartTime, duration, quality, range, state) {\r\n        let vo = new SchedulingInfo();\r\n\r\n        vo.mediaType = mediaType;\r\n        vo.t = t;\r\n\r\n        vo.type = type;\r\n        vo.startTime = startTime;\r\n        vo.availabilityStartTime = availabilityStartTime;\r\n        vo.duration = duration;\r\n        vo.quality = quality;\r\n        vo.range = range;\r\n\r\n        vo.state = state;\r\n\r\n        pushAndNotify(mediaType, MetricsConstants.SCHEDULING_INFO, vo);\r\n    }\r\n\r\n    function addRequestsQueue(mediaType, loadingRequests, executedRequests) {\r\n        let vo = new RequestsQueue();\r\n        vo.loadingRequests = loadingRequests;\r\n        vo.executedRequests = executedRequests;\r\n\r\n        getMetricsFor(mediaType).RequestsQueue = vo;\r\n        metricAdded(mediaType, MetricsConstants.REQUESTS_QUEUE, vo);\r\n    }\r\n\r\n    function addManifestUpdate(mediaType, type, requestTime, fetchTime, availabilityStartTime, presentationStartTime, clientTimeOffset, currentTime, buffered, latency) {\r\n        let vo = new ManifestUpdate();\r\n\r\n        vo.mediaType = mediaType;\r\n        vo.type = type;\r\n        vo.requestTime = requestTime; // when this manifest update was requested\r\n        vo.fetchTime = fetchTime; // when this manifest update was received\r\n        vo.availabilityStartTime = availabilityStartTime;\r\n        vo.presentationStartTime = presentationStartTime; // the seek point (liveEdge for dynamic, Stream[0].startTime for static)\r\n        vo.clientTimeOffset = clientTimeOffset; // the calculated difference between the server and client wall clock time\r\n        vo.currentTime = currentTime; // actual element.currentTime\r\n        vo.buffered = buffered; // actual element.ranges\r\n        vo.latency = latency; // (static is fixed value of zero. dynamic should be ((Now-@availabilityStartTime) - currentTime)\r\n\r\n        pushMetrics(Constants.STREAM, MetricsConstants.MANIFEST_UPDATE, vo);\r\n        metricAdded(mediaType, MetricsConstants.MANIFEST_UPDATE, vo);\r\n    }\r\n\r\n    function updateManifestUpdateInfo(manifestUpdate, updatedFields) {\r\n        if (manifestUpdate) {\r\n            for (let field in updatedFields) {\r\n                manifestUpdate[field] = updatedFields[field];\r\n            }\r\n\r\n            metricUpdated(manifestUpdate.mediaType, MetricsConstants.MANIFEST_UPDATE, manifestUpdate);\r\n        }\r\n    }\r\n\r\n    function addManifestUpdateStreamInfo(manifestUpdate, id, index, start, duration) {\r\n        if (manifestUpdate) {\r\n            let vo = new ManifestUpdateStreamInfo();\r\n\r\n            vo.id = id;\r\n            vo.index = index;\r\n            vo.start = start;\r\n            vo.duration = duration;\r\n\r\n            manifestUpdate.streamInfo.push(vo);\r\n            metricUpdated(manifestUpdate.mediaType, MetricsConstants.MANIFEST_UPDATE_STREAM_INFO, manifestUpdate);\r\n        }\r\n    }\r\n\r\n    function addManifestUpdateRepresentationInfo(manifestUpdate, id, index, streamIndex, mediaType, presentationTimeOffset, startNumber, fragmentInfoType) {\r\n        if (manifestUpdate) {\r\n\r\n            const vo = new ManifestUpdateRepresentationInfo();\r\n            vo.id = id;\r\n            vo.index = index;\r\n            vo.streamIndex = streamIndex;\r\n            vo.mediaType = mediaType;\r\n            vo.startNumber = startNumber;\r\n            vo.fragmentInfoType = fragmentInfoType;\r\n            vo.presentationTimeOffset = presentationTimeOffset;\r\n\r\n            manifestUpdate.representationInfo.push(vo);\r\n            metricUpdated(manifestUpdate.mediaType, MetricsConstants.MANIFEST_UPDATE_TRACK_INFO, manifestUpdate);\r\n        }\r\n    }\r\n\r\n    function addPlayList(vo) {\r\n        let type = Constants.STREAM;\r\n\r\n        if (vo.trace && Array.isArray(vo.trace)) {\r\n            vo.trace.forEach(trace => {\r\n                if (trace.hasOwnProperty('subreplevel') && !trace.subreplevel) {\r\n                    delete trace.subreplevel;\r\n                }\r\n            });\r\n        } else {\r\n            delete vo.trace;\r\n        }\r\n\r\n        pushAndNotify(type, MetricsConstants.PLAY_LIST, vo);\r\n    }\r\n\r\n    function addDVBErrors(vo) {\r\n        let type = Constants.STREAM;\r\n\r\n        pushAndNotify(type, MetricsConstants.DVB_ERRORS, vo);\r\n    }\r\n\r\n    instance = {\r\n        clearCurrentMetricsForType: clearCurrentMetricsForType,\r\n        clearAllCurrentMetrics: clearAllCurrentMetrics,\r\n        getReadOnlyMetricsFor: getReadOnlyMetricsFor,\r\n        getMetricsFor: getMetricsFor,\r\n        addHttpRequest: addHttpRequest,\r\n        addRepresentationSwitch: addRepresentationSwitch,\r\n        addBufferLevel: addBufferLevel,\r\n        addBufferState: addBufferState,\r\n        addDVRInfo: addDVRInfo,\r\n        addDroppedFrames: addDroppedFrames,\r\n        addSchedulingInfo: addSchedulingInfo,\r\n        addRequestsQueue: addRequestsQueue,\r\n        addManifestUpdate: addManifestUpdate,\r\n        updateManifestUpdateInfo: updateManifestUpdateInfo,\r\n        addManifestUpdateStreamInfo: addManifestUpdateStreamInfo,\r\n        addManifestUpdateRepresentationInfo: addManifestUpdateRepresentationInfo,\r\n        addPlayList: addPlayList,\r\n        addDVBErrors: addDVBErrors\r\n    };\r\n\r\n    setup();\r\n    return instance;\r\n}\r\n\r\nMetricsModel.__dashjs_factory_name = 'MetricsModel';\r\nexport default FactoryMaker.getSingletonFactory(MetricsModel);\r\n"]}