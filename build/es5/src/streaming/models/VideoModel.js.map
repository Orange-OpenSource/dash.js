{"version":3,"sources":["../../../../../src/streaming/models/VideoModel.js"],"names":["FactoryMaker","EventBus","Events","Debug","VideoModel","instance","logger","element","TTMLRenderingDiv","previousPlaybackRate","VIDEO_MODEL_WRONG_ELEMENT_TYPE","context","eventBus","getInstance","stalledStreams","setup","getLogger","initialize","on","PLAYBACK_PLAYING","onPlaying","reset","off","onPlaybackCanPlay","playbackRate","removeEventListener","setPlaybackRate","value","readyState","addEventListener","setCurrentTime","currentTime","stickToBuffered","stickTimeToBuffered","e","code","INVALID_STATE_ERR","setTimeout","time","buffered","getBufferRange","closestTime","closestDistance","i","length","start","end","distanceToStart","Math","abs","distanceToEnd","getElement","setElement","undefined","test","nodeName","preload","setSource","source","src","removeAttribute","load","getSource","getTTMLRenderingDiv","setTTMLRenderingDiv","div","style","position","display","overflow","pointerEvents","top","left","setStallState","type","state","stallStream","isStalled","addStalledStream","event","seeking","indexOf","push","document","createEvent","initEvent","dispatchEvent","removeStalledStream","index","splice","paused","getPlaybackQuality","hasWebKit","hasQuality","result","getVideoPlaybackQuality","droppedVideoFrames","webkitDroppedFrameCount","totalVideoFrames","webkitDecodedFrameCount","creationTime","Date","play","autoplay","p","catch","Promise","name","trigger","PLAYBACK_NOT_ALLOWED","warn","isPaused","pause","isSeeking","getTime","getPlaybackRate","getPlayedRanges","played","getEnded","ended","eventName","eventCallBack","getReadyState","NaN","getClientWidth","clientWidth","getClientHeight","clientHeight","getVideoWidth","videoWidth","getVideoHeight","videoHeight","getVideoRelativeOffsetTop","parentNode","getBoundingClientRect","getVideoRelativeOffsetLeft","getTextTracks","textTracks","getTextTrack","kind","label","lang","isTTML","isEmbedded","language","addTextTrack","appendChild","childElement","removeChild","__dashjs_factory_name","getSingletonFactory"],"mappings":"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","file":"VideoModel.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\n\r\nimport FactoryMaker from '../../core/FactoryMaker';\r\nimport EventBus from '../../core/EventBus';\r\nimport Events from '../../core/events/Events';\r\nimport Debug from '../../core/Debug';\r\n\r\nfunction VideoModel() {\r\n\r\n    let instance,\r\n        logger,\r\n        element,\r\n        TTMLRenderingDiv,\r\n        previousPlaybackRate;\r\n\r\n    const VIDEO_MODEL_WRONG_ELEMENT_TYPE = 'element is not video or audio DOM type!';\r\n\r\n    const context = this.context;\r\n    const eventBus = EventBus(context).getInstance();\r\n    const stalledStreams = [];\r\n\r\n    function setup() {\r\n        logger = Debug(context).getInstance().getLogger(instance);\r\n    }\r\n\r\n    function initialize() {\r\n        eventBus.on(Events.PLAYBACK_PLAYING, onPlaying, this);\r\n    }\r\n\r\n    function reset() {\r\n        eventBus.off(Events.PLAYBACK_PLAYING, onPlaying, this);\r\n    }\r\n\r\n    function onPlaybackCanPlay() {\r\n        if (element) {\r\n            element.playbackRate = previousPlaybackRate || 1;\r\n            element.removeEventListener('canplay', onPlaybackCanPlay);\r\n        }\r\n    }\r\n\r\n    function setPlaybackRate(value) {\r\n        if (!element) return;\r\n        if (element.readyState <= 2 && value > 0) {\r\n            // If media element hasn't loaded enough data to play yet, wait until it has\r\n            element.addEventListener('canplay', onPlaybackCanPlay);\r\n        } else {\r\n            element.playbackRate = value;\r\n        }\r\n    }\r\n\r\n    //TODO Move the DVR window calculations from MediaPlayer to Here.\r\n    function setCurrentTime(currentTime, stickToBuffered) {\r\n        if (element) {\r\n            //_currentTime = currentTime;\r\n\r\n            // We don't set the same currentTime because it can cause firing unexpected Pause event in IE11\r\n            // providing playbackRate property equals to zero.\r\n            if (element.currentTime == currentTime) return;\r\n\r\n            // TODO Despite the fact that MediaSource 'open' event has been fired IE11 cannot set videoElement.currentTime\r\n            // immediately (it throws InvalidStateError). It seems that this is related to videoElement.readyState property\r\n            // Initially it is 0, but soon after 'open' event it goes to 1 and setting currentTime is allowed. Chrome allows to\r\n            // set currentTime even if readyState = 0.\r\n            // setTimeout is used to workaround InvalidStateError in IE11\r\n            try {\r\n                currentTime = stickToBuffered ? stickTimeToBuffered(currentTime) : currentTime;\r\n                element.currentTime = currentTime;\r\n            } catch (e) {\r\n                if (element.readyState === 0 && e.code === e.INVALID_STATE_ERR) {\r\n                    setTimeout(function () {\r\n                        element.currentTime = currentTime;\r\n                    }, 400);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function stickTimeToBuffered(time) {\r\n        const buffered = getBufferRange();\r\n        let closestTime = time;\r\n        let closestDistance = 9999999999;\r\n        if (buffered) {\r\n            for (let i = 0; i < buffered.length; i++) {\r\n                const start = buffered.start(i);\r\n                const end = buffered.end(i);\r\n                const distanceToStart = Math.abs(start - time);\r\n                const distanceToEnd = Math.abs(end - time);\r\n\r\n                if (time >= start && time <= end) {\r\n                    return time;\r\n                }\r\n\r\n                if (distanceToStart < closestDistance) {\r\n                    closestDistance = distanceToStart;\r\n                    closestTime = start;\r\n                }\r\n\r\n                if (distanceToEnd < closestDistance) {\r\n                    closestDistance = distanceToEnd;\r\n                    closestTime = end;\r\n                }\r\n            }\r\n        }\r\n        return closestTime;\r\n    }\r\n\r\n    function getElement() {\r\n        return element;\r\n    }\r\n\r\n    function setElement(value) {\r\n        //add check of value type\r\n        if (value === null || value === undefined || (value && (/^(VIDEO|AUDIO)$/i).test(value.nodeName))) {\r\n            element = value;\r\n            // Workaround to force Firefox to fire the canplay event.\r\n            if (element) {\r\n                element.preload = 'auto';\r\n            }\r\n        } else {\r\n            throw VIDEO_MODEL_WRONG_ELEMENT_TYPE;\r\n        }\r\n    }\r\n\r\n    function setSource(source) {\r\n        if (element) {\r\n            if (source) {\r\n                element.src = source;\r\n            } else {\r\n                element.removeAttribute('src');\r\n                element.load();\r\n            }\r\n        }\r\n    }\r\n\r\n    function getSource() {\r\n        return element ? element.src : null;\r\n    }\r\n\r\n    function getTTMLRenderingDiv() {\r\n        return TTMLRenderingDiv;\r\n    }\r\n\r\n    function setTTMLRenderingDiv(div) {\r\n        TTMLRenderingDiv = div;\r\n        // The styling will allow the captions to match the video window size and position.\r\n        TTMLRenderingDiv.style.position = 'absolute';\r\n        TTMLRenderingDiv.style.display = 'flex';\r\n        TTMLRenderingDiv.style.overflow = 'hidden';\r\n        TTMLRenderingDiv.style.pointerEvents = 'none';\r\n        TTMLRenderingDiv.style.top = 0;\r\n        TTMLRenderingDiv.style.left = 0;\r\n    }\r\n\r\n    function setStallState(type, state) {\r\n        stallStream(type, state);\r\n    }\r\n\r\n    function isStalled() {\r\n        return (stalledStreams.length > 0);\r\n    }\r\n\r\n    function addStalledStream(type) {\r\n        let event;\r\n\r\n        if (type === null || element.seeking || stalledStreams.indexOf(type) !== -1) {\r\n            return;\r\n        }\r\n\r\n        stalledStreams.push(type);\r\n        if (element && stalledStreams.length === 1) {\r\n            // Halt playback until nothing is stalled.\r\n            event = document.createEvent('Event');\r\n            event.initEvent('waiting', true, false);\r\n            previousPlaybackRate = element.playbackRate;\r\n            setPlaybackRate(0);\r\n            element.dispatchEvent(event);\r\n        }\r\n    }\r\n\r\n    function removeStalledStream(type) {\r\n        let index = stalledStreams.indexOf(type);\r\n        let event;\r\n\r\n        if (type === null) {\r\n            return;\r\n        }\r\n        if (index !== -1) {\r\n            stalledStreams.splice(index, 1);\r\n        }\r\n        // If nothing is stalled resume playback.\r\n        if (element && isStalled() === false && element.playbackRate === 0) {\r\n            setPlaybackRate(previousPlaybackRate || 1);\r\n            if (!element.paused) {\r\n                event = document.createEvent('Event');\r\n                event.initEvent('playing', true, false);\r\n                element.dispatchEvent(event);\r\n            }\r\n        }\r\n    }\r\n\r\n    function stallStream(type, isStalled) {\r\n        if (isStalled) {\r\n            addStalledStream(type);\r\n        } else {\r\n            removeStalledStream(type);\r\n        }\r\n    }\r\n\r\n    //Calling play on the element will emit playing - even if the stream is stalled. If the stream is stalled, emit a waiting event.\r\n    function onPlaying() {\r\n        if (element && isStalled() && element.playbackRate === 0) {\r\n            const event = document.createEvent('Event');\r\n            event.initEvent('waiting', true, false);\r\n            element.dispatchEvent(event);\r\n        }\r\n    }\r\n\r\n    function getPlaybackQuality() {\r\n        if (!element) { return null; }\r\n        let hasWebKit = ('webkitDroppedFrameCount' in element) && ('webkitDecodedFrameCount' in element);\r\n        let hasQuality = ('getVideoPlaybackQuality' in element);\r\n        let result = null;\r\n\r\n        if (hasQuality) {\r\n            result = element.getVideoPlaybackQuality();\r\n        } else if (hasWebKit) {\r\n            result = {\r\n                droppedVideoFrames: element.webkitDroppedFrameCount,\r\n                totalVideoFrames: element.webkitDroppedFrameCount + element.webkitDecodedFrameCount,\r\n                creationTime: new Date()\r\n            };\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    function play() {\r\n        if (element) {\r\n            element.autoplay = true;\r\n            const p = element.play();\r\n            if (p && p.catch && typeof Promise !== 'undefined') {\r\n                p.catch((e) => {\r\n                    if (e.name === 'NotAllowedError') {\r\n                        eventBus.trigger(Events.PLAYBACK_NOT_ALLOWED);\r\n                    }\r\n                    logger.warn(`Caught pending play exception - continuing (${e})`);\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    function isPaused() {\r\n        return element ? element.paused : null;\r\n    }\r\n\r\n    function pause() {\r\n        if (element) {\r\n            element.pause();\r\n            element.autoplay = false;\r\n        }\r\n    }\r\n\r\n    function isSeeking() {\r\n        return element ? element.seeking : null;\r\n    }\r\n\r\n    function getTime() {\r\n        return element ? element.currentTime : null;\r\n    }\r\n\r\n    function getPlaybackRate() {\r\n        return element ? element.playbackRate : null;\r\n    }\r\n\r\n    function getPlayedRanges() {\r\n        return element ? element.played : null;\r\n    }\r\n\r\n    function getEnded() {\r\n        return element ? element.ended : null;\r\n    }\r\n\r\n    function addEventListener(eventName, eventCallBack) {\r\n        if (element) {\r\n            element.addEventListener(eventName, eventCallBack);\r\n        }\r\n    }\r\n\r\n    function removeEventListener(eventName, eventCallBack) {\r\n        if (element) {\r\n            element.removeEventListener(eventName, eventCallBack);\r\n        }\r\n    }\r\n\r\n    function getReadyState() {\r\n        return element ? element.readyState : NaN;\r\n    }\r\n\r\n    function getBufferRange() {\r\n        return element ? element.buffered : null;\r\n    }\r\n\r\n    function getClientWidth() {\r\n        return element ? element.clientWidth : NaN;\r\n    }\r\n\r\n    function getClientHeight() {\r\n        return element ? element.clientHeight : NaN;\r\n    }\r\n\r\n    function getVideoWidth() {\r\n        return element ? element.videoWidth : NaN;\r\n    }\r\n\r\n    function getVideoHeight() {\r\n        return element ? element.videoHeight : NaN;\r\n    }\r\n\r\n    function getVideoRelativeOffsetTop() {\r\n        return element && element.parentNode ? element.getBoundingClientRect().top - element.parentNode.getBoundingClientRect().top : NaN;\r\n    }\r\n\r\n    function getVideoRelativeOffsetLeft() {\r\n        return element && element.parentNode ? element.getBoundingClientRect().left - element.parentNode.getBoundingClientRect().left : NaN;\r\n    }\r\n\r\n    function getTextTracks() {\r\n        return element ? element.textTracks : [];\r\n    }\r\n\r\n    function getTextTrack(kind, label, lang, isTTML, isEmbedded) {\r\n        if (element) {\r\n            for (let i = 0; i < element.textTracks.length; i++) {\r\n                //label parameter could be a number (due to adaptationSet), but label, the attribute of textTrack, is a string => to modify...\r\n                //label could also be undefined (due to adaptationSet)\r\n                if (element.textTracks[i].kind === kind && (label ? element.textTracks[i].label == label : true) &&\r\n                   element.textTracks[i].language === lang && element.textTracks[i].isTTML === isTTML && element.textTracks[i].isEmbedded === isEmbedded) {\r\n                    return element.textTracks[i];\r\n                }\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    function addTextTrack(kind, label, lang) {\r\n        if (element) {\r\n            return element.addTextTrack(kind, label, lang);\r\n        }\r\n        return null;\r\n    }\r\n\r\n    function appendChild(childElement) {\r\n        if (element) {\r\n            element.appendChild(childElement);\r\n            //in Chrome, we need to differenciate textTrack with same lang, kind and label but different format (vtt, ttml, etc...)\r\n            if (childElement.isTTML !== undefined) {\r\n                element.textTracks[element.textTracks.length - 1].isTTML = childElement.isTTML;\r\n                element.textTracks[element.textTracks.length - 1].isEmbedded = childElement.isEmbedded;\r\n            }\r\n        }\r\n    }\r\n\r\n    function removeChild(childElement) {\r\n        if (element) {\r\n            element.removeChild(childElement);\r\n        }\r\n    }\r\n\r\n    instance = {\r\n        initialize: initialize,\r\n        setCurrentTime: setCurrentTime,\r\n        play: play,\r\n        isPaused: isPaused,\r\n        pause: pause,\r\n        isSeeking: isSeeking,\r\n        getTime: getTime,\r\n        getPlaybackRate: getPlaybackRate,\r\n        setPlaybackRate: setPlaybackRate,\r\n        getPlayedRanges: getPlayedRanges,\r\n        getEnded: getEnded,\r\n        setStallState: setStallState,\r\n        getElement: getElement,\r\n        setElement: setElement,\r\n        setSource: setSource,\r\n        getSource: getSource,\r\n        getTTMLRenderingDiv: getTTMLRenderingDiv,\r\n        setTTMLRenderingDiv: setTTMLRenderingDiv,\r\n        getPlaybackQuality: getPlaybackQuality,\r\n        addEventListener: addEventListener,\r\n        removeEventListener: removeEventListener,\r\n        getReadyState: getReadyState,\r\n        getBufferRange: getBufferRange,\r\n        getClientWidth: getClientWidth,\r\n        getClientHeight: getClientHeight,\r\n        getTextTracks: getTextTracks,\r\n        getTextTrack: getTextTrack,\r\n        addTextTrack: addTextTrack,\r\n        appendChild: appendChild,\r\n        removeChild: removeChild,\r\n        getVideoWidth: getVideoWidth,\r\n        getVideoHeight: getVideoHeight,\r\n        getVideoRelativeOffsetTop: getVideoRelativeOffsetTop,\r\n        getVideoRelativeOffsetLeft: getVideoRelativeOffsetLeft,\r\n        reset: reset\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nVideoModel.__dashjs_factory_name = 'VideoModel';\r\nexport default FactoryMaker.getSingletonFactory(VideoModel);\r\n"]}