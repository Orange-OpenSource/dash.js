{"version":3,"sources":["../../../../../../src/streaming/rules/abr/ThroughputRule.js"],"names":["BufferController","AbrController","FactoryMaker","Debug","SwitchRequest","Constants","ThroughputRule","config","context","metricsModel","instance","logger","setup","getInstance","getLogger","checkConfig","hasOwnProperty","Error","MISSING_CONFIG_ERROR","getMaxIndex","rulesContext","switchRequest","create","mediaInfo","getMediaInfo","mediaType","getMediaType","metrics","getReadOnlyMetricsFor","scheduleController","getScheduleController","abrController","getAbrController","streamInfo","getStreamInfo","isDynamic","manifestInfo","throughputHistory","getThroughputHistory","throughput","getSafeAverageThroughput","latency","getAverageLatency","bufferStateVO","BufferState","length","useBufferOccupancyABR","isNaN","getAbandonmentStateFor","ABANDON_LOAD","state","BUFFER_LOADED","quality","getQualityForBitrate","setTimeToLoadDelay","debug","Math","round","reason","reset","__dashjs_factory_name","getClassFactory"],"mappings":"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","file":"ThroughputRule.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\nimport BufferController from '../../controllers/BufferController';\r\nimport AbrController from '../../controllers/AbrController';\r\nimport FactoryMaker from '../../../core/FactoryMaker';\r\nimport Debug from '../../../core/Debug';\r\nimport SwitchRequest from '../SwitchRequest';\r\nimport Constants from '../../constants/Constants';\r\n\r\nfunction ThroughputRule(config) {\r\n\r\n    config = config || {};\r\n    const context = this.context;\r\n    const metricsModel = config.metricsModel;\r\n\r\n    let instance,\r\n        logger;\r\n\r\n    function setup() {\r\n        logger = Debug(context).getInstance().getLogger(instance);\r\n    }\r\n\r\n    function checkConfig() {\r\n        if (!metricsModel || !metricsModel.hasOwnProperty('getReadOnlyMetricsFor')) {\r\n            throw new Error(Constants.MISSING_CONFIG_ERROR);\r\n        }\r\n    }\r\n\r\n    function getMaxIndex(rulesContext) {\r\n        const switchRequest = SwitchRequest(context).create();\r\n\r\n        if (!rulesContext || !rulesContext.hasOwnProperty('getMediaInfo') || !rulesContext.hasOwnProperty('getMediaType') || !rulesContext.hasOwnProperty('useBufferOccupancyABR') ||\r\n            !rulesContext.hasOwnProperty('getAbrController') || !rulesContext.hasOwnProperty('getScheduleController')) {\r\n            return switchRequest;\r\n        }\r\n\r\n        checkConfig();\r\n\r\n        const mediaInfo = rulesContext.getMediaInfo();\r\n        const mediaType = rulesContext.getMediaType();\r\n        const metrics = metricsModel.getReadOnlyMetricsFor(mediaType);\r\n        const scheduleController = rulesContext.getScheduleController();\r\n        const abrController = rulesContext.getAbrController();\r\n        const streamInfo = rulesContext.getStreamInfo();\r\n        const isDynamic = streamInfo && streamInfo.manifestInfo ? streamInfo.manifestInfo.isDynamic : null;\r\n        const throughputHistory = abrController.getThroughputHistory();\r\n        const throughput = throughputHistory.getSafeAverageThroughput(mediaType, isDynamic);\r\n        const latency = throughputHistory.getAverageLatency(mediaType);\r\n        const bufferStateVO = (metrics.BufferState.length > 0) ? metrics.BufferState[metrics.BufferState.length - 1] : null;\r\n        const useBufferOccupancyABR = rulesContext.useBufferOccupancyABR();\r\n\r\n        if (!metrics || isNaN(throughput) || !bufferStateVO || useBufferOccupancyABR) {\r\n            return switchRequest;\r\n        }\r\n\r\n        if (abrController.getAbandonmentStateFor(mediaType) !== AbrController.ABANDON_LOAD) {\r\n            if (bufferStateVO.state === BufferController.BUFFER_LOADED || isDynamic) {\r\n                switchRequest.quality = abrController.getQualityForBitrate(mediaInfo, throughput, latency);\r\n                scheduleController.setTimeToLoadDelay(0);\r\n                logger.debug('requesting switch to index: ', switchRequest.quality, 'type: ',mediaType, 'Average throughput', Math.round(throughput), 'kbps');\r\n                switchRequest.reason = {throughput: throughput, latency: latency};\r\n            }\r\n        }\r\n\r\n        return switchRequest;\r\n    }\r\n\r\n    function reset() {\r\n        // no persistent information to reset\r\n    }\r\n\r\n    instance = {\r\n        getMaxIndex: getMaxIndex,\r\n        reset: reset\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nThroughputRule.__dashjs_factory_name = 'ThroughputRule';\r\nexport default FactoryMaker.getClassFactory(ThroughputRule);\r\n"]}