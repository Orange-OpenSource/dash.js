{"version":3,"sources":["../../../../../../src/streaming/protection/controllers/ProtectionKeyController.js"],"names":["CommonEncryption","KeySystemClearKey","KeySystemW3CClearKey","KeySystemWidevine","KeySystemPlayReady","DRMToday","PlayReady","Widevine","ClearKey","ProtectionConstants","ProtectionKeyController","context","instance","debug","logger","keySystems","BASE64","clearkeyKeySystem","clearkeyW3CKeySystem","setConfig","config","getLogger","initialize","keySystem","getInstance","push","getKeySystems","getKeySystemBySystemString","systemString","i","length","isClearKey","initDataEquals","initData1","initData2","byteLength","data1","Uint8Array","data2","j","getSupportedKeySystemsFromContentProtection","cps","cp","ks","ksIdx","cpIdx","supportedKS","schemeIdUri","toLowerCase","schemeIdURI","initData","getInitData","cdmData","getCDMData","sessionId","getSessionId","getSupportedKeySystems","protDataSet","pssh","parsePSSHList","keySystemString","shouldNotFilterOutKeySystem","uuid","getLicenseServer","protData","messageType","licenseServerData","hasOwnProperty","WIDEVINE_KEYSTEM_STRING","PLAYREADY_KEYSTEM_STRING","CLEARKEY_KEYSTEM_STRING","processClearKeyLicenseRequest","message","getClearKeysFromProtectionData","error","setProtectionData","protectionDataSet","getProtectionData","init","__dashjs_factory_name","dashjs","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"ProtectionKeyController.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\nimport CommonEncryption from './../CommonEncryption';\r\nimport KeySystemClearKey from './../drm/KeySystemClearKey';\r\nimport KeySystemW3CClearKey from './../drm/KeySystemW3CClearKey';\r\nimport KeySystemWidevine from './../drm/KeySystemWidevine';\r\nimport KeySystemPlayReady from './../drm/KeySystemPlayReady';\r\nimport DRMToday from './../servers/DRMToday';\r\nimport PlayReady from './../servers/PlayReady';\r\nimport Widevine from './../servers/Widevine';\r\nimport ClearKey from './../servers/ClearKey';\r\nimport ProtectionConstants from '../../constants/ProtectionConstants';\r\n\r\n/**\r\n * @module ProtectionKeyController\r\n * @description Media protection key system functionality that can be modified/overridden by applications\r\n */\r\nfunction ProtectionKeyController() {\r\n\r\n    let context = this.context;\r\n\r\n    let instance,\r\n        debug,\r\n        logger,\r\n        keySystems,\r\n        BASE64,\r\n        clearkeyKeySystem,\r\n        clearkeyW3CKeySystem;\r\n\r\n    function setConfig(config) {\r\n        if (!config) return;\r\n\r\n        if (config.debug) {\r\n            debug = config.debug;\r\n            logger = debug.getLogger(instance);\r\n        }\r\n\r\n        if (config.BASE64) {\r\n            BASE64 = config.BASE64;\r\n        }\r\n    }\r\n\r\n    function initialize() {\r\n        keySystems = [];\r\n\r\n        let keySystem;\r\n\r\n        // PlayReady\r\n        keySystem = KeySystemPlayReady(context).getInstance({ BASE64: BASE64 });\r\n        keySystems.push(keySystem);\r\n\r\n        // Widevine\r\n        keySystem = KeySystemWidevine(context).getInstance({ BASE64: BASE64 });\r\n        keySystems.push(keySystem);\r\n\r\n        // ClearKey\r\n        keySystem = KeySystemClearKey(context).getInstance({ BASE64: BASE64 });\r\n        keySystems.push(keySystem);\r\n        clearkeyKeySystem = keySystem;\r\n\r\n        // W3C ClearKey\r\n        keySystem = KeySystemW3CClearKey(context).getInstance({ BASE64: BASE64, debug: debug });\r\n        keySystems.push(keySystem);\r\n        clearkeyW3CKeySystem = keySystem;\r\n    }\r\n\r\n    /**\r\n     * Returns a prioritized list of key systems supported\r\n     * by this player (not necessarily those supported by the\r\n     * user agent)\r\n     *\r\n     * @returns {Array.<KeySystem>} a prioritized\r\n     * list of key systems\r\n     * @memberof module:ProtectionKeyController\r\n     * @instance\r\n     */\r\n    function getKeySystems() {\r\n        return keySystems;\r\n    }\r\n\r\n    /**\r\n     * Returns the key system associated with the given key system string\r\n     * name (i.e. 'org.w3.clearkey')\r\n     *\r\n     * @param {string} systemString the system string\r\n     * @returns {KeySystem|null} the key system\r\n     * or null if no supported key system is associated with the given key\r\n     * system string\r\n     * @memberof module:ProtectionKeyController\r\n     * @instance\r\n     */\r\n    function getKeySystemBySystemString(systemString) {\r\n        for (let i = 0; i < keySystems.length; i++) {\r\n            if (keySystems[i].systemString === systemString) {\r\n                return keySystems[i];\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Determines whether the given key system is ClearKey.  This is\r\n     * necessary because the EME spec defines ClearKey and its method\r\n     * for providing keys to the key session; and this method has changed\r\n     * between the various API versions.  Our EME-specific ProtectionModels\r\n     * must know if the system is ClearKey so that it can format the keys\r\n     * according to the particular spec version.\r\n     *\r\n     * @param {Object} keySystem the key\r\n     * @returns {boolean} true if this is the ClearKey key system, false\r\n     * otherwise\r\n     * @memberof module:ProtectionKeyController\r\n     * @instance\r\n     */\r\n    function isClearKey(keySystem) {\r\n        return (keySystem === clearkeyKeySystem || keySystem === clearkeyW3CKeySystem);\r\n    }\r\n\r\n    /**\r\n     * Check equality of initData array buffers.\r\n     *\r\n     * @param {ArrayBuffer} initData1 - first initData\r\n     * @param {ArrayBuffer} initData2 - second initData\r\n     * @returns {boolean} true if the initData arrays are equal in size and\r\n     * contents, false otherwise\r\n     * @memberof module:ProtectionKeyController\r\n     * @instance\r\n     */\r\n    function initDataEquals(initData1, initData2) {\r\n        if (initData1.byteLength === initData2.byteLength) {\r\n            let data1 = new Uint8Array(initData1);\r\n            let data2 = new Uint8Array(initData2);\r\n\r\n            for (let j = 0; j < data1.length; j++) {\r\n                if (data1[j] !== data2[j]) {\r\n                    return false;\r\n                }\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Returns a set of supported key systems and CENC initialization data\r\n     * from the given array of ContentProtection elements.  Only\r\n     * key systems that are supported by this player will be returned.\r\n     * Key systems are returned in priority order (highest first).\r\n     *\r\n     * @param {Array.<Object>} cps - array of content protection elements parsed\r\n     * from the manifest\r\n     * @returns {Array.<Object>} array of objects indicating which supported key\r\n     * systems were found.  Empty array is returned if no\r\n     * supported key systems were found\r\n     * @memberof module:ProtectionKeyController\r\n     * @instance\r\n     */\r\n    function getSupportedKeySystemsFromContentProtection(cps) {\r\n        let cp, ks, ksIdx, cpIdx;\r\n        let supportedKS = [];\r\n\r\n        if (cps) {\r\n            for (ksIdx = 0; ksIdx < keySystems.length; ++ksIdx) {\r\n                ks = keySystems[ksIdx];\r\n                for (cpIdx = 0; cpIdx < cps.length; ++cpIdx) {\r\n                    cp = cps[cpIdx];\r\n                    if (cp.schemeIdUri.toLowerCase() === ks.schemeIdURI) {\r\n                        // Look for DRM-specific ContentProtection\r\n                        let initData = ks.getInitData(cp);\r\n                        if (!!initData) {\r\n                            supportedKS.push({\r\n                                ks: keySystems[ksIdx],\r\n                                initData: initData,\r\n                                cdmData: ks.getCDMData(),\r\n                                sessionId: ks.getSessionId(cp)\r\n                            });\r\n                        } else if (this.isClearKey(ks)) {\r\n                            supportedKS.push({\r\n                                ks: ks,\r\n                                initData: null\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return supportedKS;\r\n    }\r\n\r\n    /**\r\n     * Returns key systems supported by this player for the given PSSH\r\n     * initializationData. Only key systems supported by this player\r\n     * that have protection data present will be returned.  Key systems are returned in priority order\r\n     * (highest priority first)\r\n     *\r\n     * @param {ArrayBuffer} initData Concatenated PSSH data for all DRMs\r\n     * supported by the content\r\n     * @param {ProtectionData} protDataSet user specified protection data - license server url etc\r\n     * supported by the content\r\n     * @returns {Array.<Object>} array of objects indicating which supported key\r\n     * systems were found.  Empty array is returned if no\r\n     * supported key systems were found\r\n     * @memberof module:ProtectionKeyController\r\n     * @instance\r\n     */\r\n    function getSupportedKeySystems(initData, protDataSet) {\r\n        let supportedKS = [];\r\n        let pssh = CommonEncryption.parsePSSHList(initData);\r\n        let ks, keySystemString, shouldNotFilterOutKeySystem;\r\n\r\n        for (let ksIdx = 0; ksIdx < keySystems.length; ++ksIdx) {\r\n            ks = keySystems[ksIdx];\r\n            keySystemString = ks.systemString;\r\n            shouldNotFilterOutKeySystem = (protDataSet) ? keySystemString in protDataSet : true;\r\n\r\n            if (ks.uuid in pssh && shouldNotFilterOutKeySystem) {\r\n                supportedKS.push({\r\n                    ks: ks,\r\n                    initData: pssh[ks.uuid],\r\n                    cdmData: ks.getCDMData(),\r\n                    sessionId: ks.getSessionId()\r\n                });\r\n            }\r\n        }\r\n        return supportedKS;\r\n    }\r\n\r\n    /**\r\n     * Returns the license server implementation data that should be used for this request.\r\n     *\r\n     * @param {KeySystem} keySystem the key system\r\n     * associated with this license request\r\n     * @param {ProtectionData} protData protection data to use for the\r\n     * request\r\n     * @param {string} [messageType=\"license-request\"] the message type associated with this\r\n     * request.  Supported message types can be found\r\n     * {@link https://w3c.github.io/encrypted-media/#idl-def-MediaKeyMessageType|here}.\r\n     * @returns {LicenseServer|null} the license server\r\n     * implementation that should be used for this request or null if the player should not\r\n     * pass messages of the given type to a license server\r\n     * @memberof module:ProtectionKeyController\r\n     * @instance\r\n     *\r\n     */\r\n    function getLicenseServer(keySystem, protData, messageType) {\r\n\r\n        // Our default server implementations do not do anything with \"license-release\" or\r\n        // \"individualization-request\" messages, so we just send a success event\r\n        if (messageType === 'license-release' || messageType === 'individualization-request') {\r\n            return null;\r\n        }\r\n\r\n        let licenseServerData = null;\r\n        if (protData && protData.hasOwnProperty('drmtoday')) {\r\n            licenseServerData = DRMToday(context).getInstance({ BASE64: BASE64 });\r\n        } else if (keySystem.systemString === ProtectionConstants.WIDEVINE_KEYSTEM_STRING) {\r\n            licenseServerData = Widevine(context).getInstance();\r\n        } else if (keySystem.systemString === ProtectionConstants.PLAYREADY_KEYSTEM_STRING) {\r\n            licenseServerData = PlayReady(context).getInstance();\r\n        } else if (keySystem.systemString === ProtectionConstants.CLEARKEY_KEYSTEM_STRING) {\r\n            licenseServerData = ClearKey(context).getInstance();\r\n        }\r\n\r\n        return licenseServerData;\r\n    }\r\n\r\n    /**\r\n     * Allows application-specific retrieval of ClearKey keys.\r\n     *\r\n     * @param {KeySystem} clearkeyKeySystem They exact ClearKey System to be used\r\n     * @param {ProtectionData} protData protection data to use for the\r\n     * request\r\n     * @param {ArrayBuffer} message the key message from the CDM\r\n     * @return {ClearKeyKeySet|null} the clear keys associated with\r\n     * the request or null if no keys can be returned by this function\r\n     * @memberof module:ProtectionKeyController\r\n     * @instance\r\n     */\r\n    function processClearKeyLicenseRequest(clearkeyKeySystem, protData, message) {\r\n        try {\r\n            return clearkeyKeySystem.getClearKeysFromProtectionData(protData, message);\r\n        } catch (error) {\r\n            logger.error('Failed to retrieve clearkeys from ProtectionData');\r\n            return null;\r\n        }\r\n    }\r\n\r\n    function setProtectionData(protectionDataSet) {\r\n        var getProtectionData = function (keySystemString) {\r\n            var protData = null;\r\n            if (protectionDataSet) {\r\n                protData = (keySystemString in protectionDataSet) ? protectionDataSet[keySystemString] : null;\r\n            }\r\n            return protData;\r\n        };\r\n\r\n        for (var i = 0; i < keySystems.length; i++) {\r\n            var keySystem = keySystems[i];\r\n            if (keySystem.hasOwnProperty('init')) {\r\n                keySystem.init(getProtectionData(keySystem.systemString));\r\n            }\r\n        }\r\n    }\r\n\r\n    instance = {\r\n        initialize: initialize,\r\n        setProtectionData: setProtectionData,\r\n        isClearKey: isClearKey,\r\n        initDataEquals: initDataEquals,\r\n        getKeySystems: getKeySystems,\r\n        getKeySystemBySystemString: getKeySystemBySystemString,\r\n        getSupportedKeySystemsFromContentProtection: getSupportedKeySystemsFromContentProtection,\r\n        getSupportedKeySystems: getSupportedKeySystems,\r\n        getLicenseServer: getLicenseServer,\r\n        processClearKeyLicenseRequest: processClearKeyLicenseRequest,\r\n        setConfig: setConfig\r\n    };\r\n\r\n    return instance;\r\n}\r\n\r\nProtectionKeyController.__dashjs_factory_name = 'ProtectionKeyController';\r\nexport default dashjs.FactoryMaker.getSingletonFactory(ProtectionKeyController); /* jshint ignore:line */\r\n"]}