{"version":3,"sources":["../../../../../../src/streaming/protection/models/ProtectionModel_21Jan2015.js"],"names":["ProtectionModel_21Jan2015","config","context","eventBus","events","debug","instance","logger","keySystem","videoElement","mediaKeys","sessions","eventHandler","protectionKeyController","setup","getLogger","getInstance","createEventHandler","reset","numSessions","length","session","done","removeSession","removeEventListener","setMediaKeys","then","trigger","TEARDOWN_COMPLETE","i","s","closed","closeKeySessionInternal","catch","stop","getUsable","getKeySystem","getAllInitData","retVal","initData","push","requestKeySystemAccess","ksConfigurations","requestKeySystemAccessInternal","selectKeySystem","keySystemAccess","mksa","createMediaKeys","mkeys","INTERNAL_KEY_SYSTEM_SELECTED","error","systemString","setMediaElement","mediaElement","addEventListener","setServerCertificate","serverCertificate","Error","info","SERVER_CERTIFICATE_UPDATED","DashJSError","ProtectionErrors","SERVER_CERTIFICATE_UPDATED_ERROR_CODE","SERVER_CERTIFICATE_UPDATED_ERROR_MESSAGE","name","createKeySession","protData","sessionType","cdmData","Uint8Array","createSession","sessionToken","createSessionToken","ks","dataType","ProtectionConstants","CLEARKEY_KEYSTEM_STRING","clearkeys","generateRequest","getSessionID","KEY_SESSION_CREATED","data","KEY_SESSION_CREATED_ERROR_CODE","KEY_SESSION_CREATED_ERROR_MESSAGE","updateKeySession","message","btoa","String","fromCharCode","apply","isClearKey","toJWK","update","KEY_ERROR","MEDIA_KEYERR_CODE","loadKeySession","sessionID","sessionId","warn","load","success","removeKeySession","remove","KEY_SESSION_REMOVED","closeKeySession","KEY_SESSION_CLOSED","idx","navigator","requestMediaKeySystemAccess","undefined","KEY_SYSTEM_ACCESS_COMPLETE","configs","PLAYREADY_KEYSTEM_STRING","persistentState","mediaKeySystemAccess","configuration","getConfiguration","KeySystemAccess","close","handleEvent","event","type","ArrayBuffer","isView","buffer","NEED_KEY","key","NeedKey","initDataType","token","splice","parseKeyStatus","args","status","keyId","KEY_STATUSES_CHANGED","target","keyStatuses","forEach","keyStatus","arguments","INTERNAL_KEY_STATUS_CHANGED","KEY_STATUS_CHANGED_EXPIRED_ERROR_CODE","KEY_STATUS_CHANGED_EXPIRED_ERROR_MESSAGE","INTERNAL_KEY_MESSAGE","KeyMessage","messageType","getExpirationTime","expiration","getKeyStatuses","usable","getSessionType","__dashjs_factory_name","dashjs","FactoryMaker","getClassFactory"],"mappings":"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","file":"ProtectionModel_21Jan2015.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\n\r\n/**\r\n * Most recent EME implementation\r\n *\r\n * Implemented by Google Chrome v36+ (Windows, OSX, Linux)\r\n *\r\n * @implements ProtectionModel\r\n * @class\r\n */\r\nimport ProtectionKeyController from '../controllers/ProtectionKeyController';\r\nimport NeedKey from '../vo/NeedKey';\r\nimport ProtectionErrors from '../errors/ProtectionErrors';\r\nimport DashJSError from '../../vo/DashJSError';\r\nimport KeyMessage from '../vo/KeyMessage';\r\nimport KeySystemAccess from '../vo/KeySystemAccess';\r\nimport ProtectionConstants from '../../constants/ProtectionConstants';\r\n\r\nfunction ProtectionModel_21Jan2015(config) {\r\n\r\n    config = config || {};\r\n    const context = this.context;\r\n    const eventBus = config.eventBus;//Need to pass in here so we can use same instance since this is optional module\r\n    const events = config.events;\r\n    const debug = config.debug;\r\n\r\n    let instance,\r\n        logger,\r\n        keySystem,\r\n        videoElement,\r\n        mediaKeys,\r\n        sessions,\r\n        eventHandler,\r\n        protectionKeyController;\r\n\r\n    function setup() {\r\n        logger = debug.getLogger(instance);\r\n        keySystem = null;\r\n        videoElement = null;\r\n        mediaKeys = null;\r\n        sessions = [];\r\n        protectionKeyController = ProtectionKeyController(context).getInstance();\r\n        eventHandler = createEventHandler();\r\n    }\r\n\r\n    function reset() {\r\n        const numSessions = sessions.length;\r\n        let session;\r\n\r\n        if (numSessions !== 0) {\r\n            // Called when we are done closing a session.  Success or fail\r\n            const done = function (session) {\r\n                removeSession(session);\r\n                if (sessions.length === 0) {\r\n                    if (videoElement) {\r\n                        videoElement.removeEventListener('encrypted', eventHandler);\r\n                        videoElement.setMediaKeys(null).then(function () {\r\n                            eventBus.trigger(events.TEARDOWN_COMPLETE);\r\n                        });\r\n                    } else {\r\n                        eventBus.trigger(events.TEARDOWN_COMPLETE);\r\n                    }\r\n                }\r\n            };\r\n            for (let i = 0; i < numSessions; i++) {\r\n                session = sessions[i];\r\n                (function (s) {\r\n                    // Override closed promise resolver\r\n                    session.session.closed.then(function () {\r\n                        done(s);\r\n                    });\r\n                    // Close the session and handle errors, otherwise promise\r\n                    // resolver above will be called\r\n                    closeKeySessionInternal(session).catch(function () {\r\n                        done(s);\r\n                    });\r\n\r\n                })(session);\r\n            }\r\n        } else {\r\n            eventBus.trigger(events.TEARDOWN_COMPLETE);\r\n        }\r\n    }\r\n\r\n    function stop() {\r\n        // Close and remove not usable sessions\r\n        let session;\r\n        for (let i = 0; i < sessions.length; i++) {\r\n            session = sessions[i];\r\n            if (!session.getUsable()) {\r\n                closeKeySessionInternal(session).catch(function () {\r\n                    removeSession(session);\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    function getKeySystem() {\r\n        return keySystem;\r\n    }\r\n\r\n    function getAllInitData() {\r\n        const retVal = [];\r\n        for (let i = 0; i < sessions.length; i++) {\r\n            if (sessions[i].initData) {\r\n                retVal.push(sessions[i].initData);\r\n            }\r\n        }\r\n        return retVal;\r\n    }\r\n\r\n    function requestKeySystemAccess(ksConfigurations) {\r\n        requestKeySystemAccessInternal(ksConfigurations, 0);\r\n    }\r\n\r\n    function selectKeySystem(keySystemAccess) {\r\n        keySystemAccess.mksa.createMediaKeys().then(function (mkeys) {\r\n            keySystem = keySystemAccess.keySystem;\r\n            mediaKeys = mkeys;\r\n            if (videoElement) {\r\n                videoElement.setMediaKeys(mediaKeys).then(function () {\r\n                    eventBus.trigger(events.INTERNAL_KEY_SYSTEM_SELECTED);\r\n                });\r\n            } else {\r\n                eventBus.trigger(events.INTERNAL_KEY_SYSTEM_SELECTED);\r\n            }\r\n\r\n        }).catch(function () {\r\n            eventBus.trigger(events.INTERNAL_KEY_SYSTEM_SELECTED, {error: 'Error selecting keys system (' + keySystemAccess.keySystem.systemString + ')! Could not create MediaKeys -- TODO'});\r\n        });\r\n    }\r\n\r\n    function setMediaElement(mediaElement) {\r\n        if (videoElement === mediaElement)\r\n            return;\r\n\r\n        // Replacing the previous element\r\n        if (videoElement) {\r\n            videoElement.removeEventListener('encrypted', eventHandler);\r\n            if (videoElement.setMediaKeys) {\r\n                videoElement.setMediaKeys(null);\r\n            }\r\n        }\r\n\r\n        videoElement = mediaElement;\r\n\r\n        // Only if we are not detaching from the existing element\r\n        if (videoElement) {\r\n            videoElement.addEventListener('encrypted', eventHandler);\r\n            if (videoElement.setMediaKeys && mediaKeys) {\r\n                videoElement.setMediaKeys(mediaKeys);\r\n            }\r\n        }\r\n    }\r\n\r\n    function setServerCertificate(serverCertificate) {\r\n        if (!keySystem || !mediaKeys) {\r\n            throw new Error('Can not set server certificate until you have selected a key system');\r\n        }\r\n        mediaKeys.setServerCertificate(serverCertificate).then(function () {\r\n            logger.info('DRM: License server certificate successfully updated.');\r\n            eventBus.trigger(events.SERVER_CERTIFICATE_UPDATED);\r\n        }).catch(function (error) {\r\n            eventBus.trigger(events.SERVER_CERTIFICATE_UPDATED, {error: new DashJSError(ProtectionErrors.SERVER_CERTIFICATE_UPDATED_ERROR_CODE, ProtectionErrors.SERVER_CERTIFICATE_UPDATED_ERROR_MESSAGE + error.name)});\r\n        });\r\n    }\r\n\r\n    function createKeySession(initData, protData, sessionType, cdmData) {\r\n        if (!keySystem || !mediaKeys) {\r\n            throw new Error('Can not create sessions until you have selected a key system');\r\n        }\r\n\r\n        // Patch for StickTV: provide CustomData to PlayReady CDM using setServerCertificate API\r\n        if (cdmData && keySystem.systemString === 'com.microsoft.playready') {\r\n            mediaKeys.setServerCertificate(new Uint8Array(cdmData));\r\n        }\r\n\r\n        const session = mediaKeys.createSession(sessionType);\r\n        const sessionToken = createSessionToken(session, initData, sessionType);\r\n        const ks = this.getKeySystem();\r\n\r\n        // Generate initial key request.\r\n        // keyids type is used for clearkey when keys are provided directly in the protection data and then request to a license server is not needed\r\n        const dataType = ks.systemString === ProtectionConstants.CLEARKEY_KEYSTEM_STRING && protData && protData.clearkeys ? 'keyids' : 'cenc';\r\n        session.generateRequest(dataType, initData).then(function () {\r\n            logger.debug('DRM: Session created.  SessionID = ' + sessionToken.getSessionID());\r\n            eventBus.trigger(events.KEY_SESSION_CREATED, {data: sessionToken});\r\n        }).catch(function (error) {\r\n            // TODO: Better error string\r\n            removeSession(sessionToken);\r\n            eventBus.trigger(events.KEY_SESSION_CREATED, {data: null, error: new DashJSError(ProtectionErrors.KEY_SESSION_CREATED_ERROR_CODE, ProtectionErrors.KEY_SESSION_CREATED_ERROR_MESSAGE + 'Error generating key request -- ' + error.name)});\r\n        });\r\n    }\r\n\r\n    function updateKeySession(sessionToken, message) {\r\n        const session = sessionToken.session;\r\n\r\n        logger.debug('DRM: license: ' + btoa(String.fromCharCode.apply(null, new Uint8Array(message))));\r\n\r\n        // Send our request to the key session\r\n        if (protectionKeyController.isClearKey(keySystem)) {\r\n            message = message.toJWK();\r\n        }\r\n        session.update(message).catch(function (error) {\r\n            eventBus.trigger(events.KEY_ERROR, {data: new DashJSError(ProtectionErrors.MEDIA_KEYERR_CODE, 'Error sending update() message! ' + error.name, sessionToken)});\r\n        });\r\n    }\r\n\r\n    function loadKeySession(sessionID, initData, sessionType) {\r\n        if (!keySystem || !mediaKeys) {\r\n            throw new Error('Can not load sessions until you have selected a key system');\r\n        }\r\n\r\n        // Check if session Id is not already loaded or loading\r\n        for (let i = 0; i < sessions.length; i++) {\r\n            if (sessionID === sessions[i].sessionId) {\r\n                logger.warn('DRM: Ignoring session ID because we have already seen it!');\r\n                return;\r\n            }\r\n        }\r\n\r\n        const session = mediaKeys.createSession(sessionType);\r\n        const sessionToken = createSessionToken(session, initData, sessionType, sessionID);\r\n\r\n        // Load persisted session data into our newly created session object\r\n        session.load(sessionID).then(function (success) {\r\n            if (success) {\r\n                logger.debug('DRM: Session loaded.  SessionID = ' + sessionToken.getSessionID());\r\n                eventBus.trigger(events.KEY_SESSION_CREATED, {data: sessionToken});\r\n            } else {\r\n                removeSession(sessionToken);\r\n                eventBus.trigger(events.KEY_SESSION_CREATED, {data: null, error: new DashJSError(ProtectionErrors.KEY_SESSION_CREATED_ERROR_CODE, ProtectionErrors.KEY_SESSION_CREATED_ERROR_MESSAGE + 'Could not load session! Invalid Session ID (' + sessionID + ')')});\r\n            }\r\n        }).catch(function (error) {\r\n            removeSession(sessionToken);\r\n            eventBus.trigger(events.KEY_SESSION_CREATED, {data: null, error: new DashJSError(ProtectionErrors.KEY_SESSION_CREATED_ERROR_CODE, ProtectionErrors.KEY_SESSION_CREATED_ERROR_MESSAGE + 'Could not load session (' + sessionID + ')! ' + error.name)});\r\n        });\r\n    }\r\n\r\n    function removeKeySession(sessionToken) {\r\n        const session = sessionToken.session;\r\n\r\n        session.remove().then(function () {\r\n            logger.debug('DRM: Session removed.  SessionID = ' + sessionToken.getSessionID());\r\n            eventBus.trigger(events.KEY_SESSION_REMOVED, {data: sessionToken.getSessionID()});\r\n        }, function (error) {\r\n            eventBus.trigger(events.KEY_SESSION_REMOVED, {data: null, error: 'Error removing session (' + sessionToken.getSessionID() + '). ' + error.name});\r\n\r\n        });\r\n    }\r\n\r\n    function closeKeySession(sessionToken) {\r\n        // Send our request to the key session\r\n        closeKeySessionInternal(sessionToken).catch(function (error) {\r\n            removeSession(sessionToken);\r\n            eventBus.trigger(events.KEY_SESSION_CLOSED, {data: null, error: 'Error closing session (' + sessionToken.getSessionID() + ') ' + error.name});\r\n        });\r\n    }\r\n\r\n    function requestKeySystemAccessInternal(ksConfigurations, idx) {\r\n\r\n        if (navigator.requestMediaKeySystemAccess === undefined ||\r\n            typeof navigator.requestMediaKeySystemAccess !== 'function') {\r\n            eventBus.trigger(events.KEY_SYSTEM_ACCESS_COMPLETE, {error: 'Insecure origins are not allowed'});\r\n            return;\r\n        }\r\n\r\n        (function (i) {\r\n            const keySystem = ksConfigurations[i].ks;\r\n            const configs = ksConfigurations[i].configs;\r\n            let systemString = keySystem.systemString;\r\n\r\n            // PATCH to support persistent licenses on Edge browser (see issue #2658)\r\n            if (systemString === ProtectionConstants.PLAYREADY_KEYSTEM_STRING && configs[0].persistentState === 'required') {\r\n                systemString += '.recommendation';\r\n            }\r\n\r\n            navigator.requestMediaKeySystemAccess(systemString, configs).then(function (mediaKeySystemAccess) {\r\n                // Chrome 40 does not currently implement MediaKeySystemAccess.getConfiguration()\r\n                const configuration = (typeof mediaKeySystemAccess.getConfiguration === 'function') ?\r\n                        mediaKeySystemAccess.getConfiguration() : null;\r\n                const keySystemAccess = new KeySystemAccess(keySystem, configuration);\r\n                keySystemAccess.mksa = mediaKeySystemAccess;\r\n                eventBus.trigger(events.KEY_SYSTEM_ACCESS_COMPLETE, {data: keySystemAccess});\r\n\r\n            }).catch(function (error) {\r\n                if (++i < ksConfigurations.length) {\r\n                    requestKeySystemAccessInternal(ksConfigurations, i);\r\n                } else {\r\n                    eventBus.trigger(events.KEY_SYSTEM_ACCESS_COMPLETE, {error: 'Key system access denied! ' + error.message});\r\n                }\r\n            });\r\n        })(idx);\r\n    }\r\n\r\n    function closeKeySessionInternal(sessionToken) {\r\n        const session = sessionToken.session;\r\n\r\n        // Remove event listeners\r\n        session.removeEventListener('keystatuseschange', sessionToken);\r\n        session.removeEventListener('message', sessionToken);\r\n\r\n        // Send our request to the key session\r\n        return session.close();\r\n    }\r\n\r\n    // This is our main event handler for all desired HTMLMediaElement events\r\n    // related to EME.  These events are translated into our API-independent\r\n    // versions of the same events\r\n    function createEventHandler() {\r\n        return {\r\n            handleEvent: function (event) {\r\n                switch (event.type) {\r\n                    case 'encrypted':\r\n                        if (event.initData) {\r\n                            let initData = ArrayBuffer.isView(event.initData) ? event.initData.buffer : event.initData;\r\n                            eventBus.trigger(events.NEED_KEY, {key: new NeedKey(initData, event.initDataType)});\r\n                        }\r\n                        break;\r\n                }\r\n            }\r\n        };\r\n    }\r\n\r\n    function removeSession(token) {\r\n        // Remove from our session list\r\n        for (let i = 0; i < sessions.length; i++) {\r\n            if (sessions[i] === token) {\r\n                sessions.splice(i,1);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    function parseKeyStatus(args) {\r\n        // Edge and Chrome implement different version of keystatues, param are not on same order\r\n        let status, keyId;\r\n        if (args && args.length > 0) {\r\n            if (args[0]) {\r\n                if (typeof args[0] === 'string') {\r\n                    status = args[0];\r\n                } else {\r\n                    keyId = args[0];\r\n                }\r\n            }\r\n\r\n            if (args[1]) {\r\n                if (typeof args[1] === 'string') {\r\n                    status = args[1];\r\n                } else {\r\n                    keyId = args[1];\r\n                }\r\n            }\r\n        }\r\n        return {\r\n            status: status,\r\n            keyId: keyId\r\n        };\r\n    }\r\n\r\n    // Function to create our session token objects which manage the EME\r\n    // MediaKeySession and session-specific event handler\r\n    function createSessionToken(session, initData, sessionType, sessionID) {\r\n        const token = { // Implements SessionToken\r\n            session: session,\r\n            initData: initData,\r\n            sessionId: sessionID,\r\n\r\n            // This is our main event handler for all desired MediaKeySession events\r\n            // These events are translated into our API-independent versions of the\r\n            // same events\r\n            handleEvent: function (event) {\r\n                switch (event.type) {\r\n                    case 'keystatuseschange':\r\n                        eventBus.trigger(events.KEY_STATUSES_CHANGED, {data: this});\r\n                        event.target.keyStatuses.forEach(function () {\r\n                            let keyStatus = parseKeyStatus(arguments);\r\n                            switch (keyStatus.status) {\r\n                                case 'expired':\r\n                                    eventBus.trigger(events.INTERNAL_KEY_STATUS_CHANGED, {error: new DashJSError(ProtectionErrors.KEY_STATUS_CHANGED_EXPIRED_ERROR_CODE, ProtectionErrors.KEY_STATUS_CHANGED_EXPIRED_ERROR_MESSAGE)});\r\n                                    break;\r\n                                default:\r\n                                    eventBus.trigger(events.INTERNAL_KEY_STATUS_CHANGED, keyStatus);\r\n                                    break;\r\n                            }\r\n                        });\r\n                        break;\r\n\r\n                    case 'message':\r\n                        let message = ArrayBuffer.isView(event.message) ? event.message.buffer : event.message;\r\n                        eventBus.trigger(events.INTERNAL_KEY_MESSAGE, {data: new KeyMessage(this, message, undefined, event.messageType)});\r\n                        break;\r\n                }\r\n            },\r\n\r\n            getSessionID: function () {\r\n                return session.sessionId;\r\n            },\r\n\r\n            getExpirationTime: function () {\r\n                return session.expiration;\r\n            },\r\n\r\n            getKeyStatuses: function () {\r\n                return session.keyStatuses;\r\n            },\r\n\r\n            getUsable: function () {\r\n                let usable  = false;\r\n                session.keyStatuses.forEach(function () {\r\n                    let keyStatus = parseKeyStatus(arguments);\r\n                    if (keyStatus.status === 'usable') {\r\n                        usable = true;\r\n                    }\r\n                });\r\n                return usable;\r\n            },\r\n\r\n            getSessionType: function () {\r\n                return sessionType;\r\n            }\r\n        };\r\n\r\n        // Add all event listeners\r\n        session.addEventListener('keystatuseschange', token);\r\n        session.addEventListener('message', token);\r\n\r\n        // Register callback for session closed Promise\r\n        session.closed.then(function () {\r\n            removeSession(token);\r\n            logger.debug('DRM: Session closed.  SessionID = ' + token.getSessionID());\r\n            eventBus.trigger(events.KEY_SESSION_CLOSED, {data: token.getSessionID()});\r\n        });\r\n\r\n        // Add to our session list\r\n        sessions.push(token);\r\n\r\n        return token;\r\n    }\r\n\r\n    instance = {\r\n        getAllInitData: getAllInitData,\r\n        requestKeySystemAccess: requestKeySystemAccess,\r\n        getKeySystem: getKeySystem,\r\n        selectKeySystem: selectKeySystem,\r\n        setMediaElement: setMediaElement,\r\n        setServerCertificate: setServerCertificate,\r\n        createKeySession: createKeySession,\r\n        updateKeySession: updateKeySession,\r\n        loadKeySession: loadKeySession,\r\n        removeKeySession: removeKeySession,\r\n        closeKeySession: closeKeySession,\r\n        stop: stop,\r\n        reset: reset\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nProtectionModel_21Jan2015.__dashjs_factory_name = 'ProtectionModel_21Jan2015';\r\nexport default dashjs.FactoryMaker.getClassFactory(ProtectionModel_21Jan2015); /* jshint ignore:line */\r\n"]}