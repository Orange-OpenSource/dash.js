{"version":3,"sources":["../../../../../../src/streaming/metrics/utils/ManifestParsing.js"],"names":["Metrics","Range","Reporting","ManifestParsing","config","instance","dashManifestModel","constants","getMetricsRangeStartTime","manifest","dynamic","range","mpd","getMpd","voPeriods","presentationStartTime","reportingStartTime","availabilityStartTime","getTime","getRegularPeriods","length","start","hasOwnProperty","START_TIME","starttime","getMetrics","metrics","Metrics_asArray","forEach","metric","metricEntry","isDynamic","getIsDynamic","Range_asArray","rangeEntry","duration","getDuration","_useWallClockTime","push","Reporting_asArray","reporting","reportingEntry","SCHEME_ID_URI","schemeIdUri","prop","__dashjs_factory_name","dashjs","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"ManifestParsing.js","sourcesContent":["import Metrics from '../vo/Metrics';\r\nimport Range from '../vo/Range';\r\nimport Reporting from '../vo/Reporting';\r\n\r\nfunction ManifestParsing (config) {\r\n    config = config || {};\r\n    let instance;\r\n    let dashManifestModel = config.dashManifestModel;\r\n    const constants = config.constants;\r\n\r\n    function getMetricsRangeStartTime(manifest, dynamic, range) {\r\n        var mpd = dashManifestModel.getMpd(manifest);\r\n        var voPeriods;\r\n        var presentationStartTime = 0;\r\n        var reportingStartTime;\r\n\r\n        if (dynamic) {\r\n            // For services with MPD@type='dynamic', the start time is\r\n            // indicated in wall clock time by adding the value of this\r\n            // attribute to the value of the MPD@availabilityStartTime\r\n            // attribute.\r\n            presentationStartTime = mpd.availabilityStartTime.getTime() / 1000;\r\n        } else {\r\n            // For services with MPD@type='static', the start time is indicated\r\n            // in Media Presentation time and is relative to the PeriodStart\r\n            // time of the first Period in this MPD.\r\n            voPeriods = this.getRegularPeriods(mpd);\r\n\r\n            if (voPeriods.length) {\r\n                presentationStartTime = voPeriods[0].start;\r\n            }\r\n        }\r\n\r\n        // When not present, DASH Metrics collection is\r\n        // requested from the beginning of content\r\n        // consumption.\r\n        reportingStartTime = presentationStartTime;\r\n\r\n        if (range && range.hasOwnProperty(constants.START_TIME)) {\r\n            reportingStartTime += range.starttime;\r\n        }\r\n\r\n        return reportingStartTime;\r\n    }\r\n\r\n    function getMetrics(manifest) {\r\n        var metrics = [];\r\n\r\n        if (manifest.Metrics_asArray) {\r\n            manifest.Metrics_asArray.forEach(metric => {\r\n                var metricEntry = new Metrics();\r\n                var isDynamic = dashManifestModel.getIsDynamic(manifest);\r\n\r\n                if (metric.hasOwnProperty('metrics')) {\r\n                    metricEntry.metrics = metric.metrics;\r\n                } else {\r\n                    return;\r\n                }\r\n\r\n                if (metric.Range_asArray) {\r\n                    metric.Range_asArray.forEach(range => {\r\n                        var rangeEntry = new Range();\r\n\r\n                        rangeEntry.starttime =\r\n                            getMetricsRangeStartTime(manifest, isDynamic, range);\r\n\r\n                        if (range.hasOwnProperty('duration')) {\r\n                            rangeEntry.duration = range.duration;\r\n                        } else {\r\n                            // if not present, the value is identical to the\r\n                            // Media Presentation duration.\r\n                            rangeEntry.duration = dashManifestModel.getDuration(manifest);\r\n                        }\r\n\r\n                        rangeEntry._useWallClockTime = isDynamic;\r\n\r\n                        metricEntry.Range.push(rangeEntry);\r\n                    });\r\n                }\r\n\r\n                if (metric.Reporting_asArray) {\r\n                    metric.Reporting_asArray.forEach(reporting => {\r\n                        var reportingEntry = new Reporting();\r\n\r\n                        if (reporting.hasOwnProperty(constants.SCHEME_ID_URI)) {\r\n                            reportingEntry.schemeIdUri = reporting.schemeIdUri;\r\n                        } else {\r\n                            // Invalid Reporting. schemeIdUri must be set. Ignore.\r\n                            return;\r\n                        }\r\n\r\n                        for (const prop in reporting) {\r\n                            if (reporting.hasOwnProperty(prop)) {\r\n                                reportingEntry[prop] = reporting[prop];\r\n                            }\r\n                        }\r\n\r\n                        metricEntry.Reporting.push(reportingEntry);\r\n                    });\r\n                } else {\r\n                    // Invalid Metrics. At least one reporting must be present. Ignore\r\n                    return;\r\n                }\r\n\r\n                metrics.push(metricEntry);\r\n            });\r\n        }\r\n\r\n        return metrics;\r\n    }\r\n\r\n    instance = {\r\n        getMetrics: getMetrics\r\n    };\r\n\r\n    return instance;\r\n}\r\n\r\nManifestParsing.__dashjs_factory_name = 'ManifestParsing';\r\nexport default dashjs.FactoryMaker.getSingletonFactory(ManifestParsing); /* jshint ignore:line */"]}