{"version":3,"sources":["../../../../../src/dash/controllers/RepresentationController.js"],"names":["Constants","Errors","DashConstants","DashJSError","EventBus","Events","FactoryMaker","Representation","RepresentationController","context","eventBus","getInstance","instance","realAdaptation","realAdaptationIndex","updating","voAvailableRepresentations","currentVoRepresentation","abrController","indexHandler","playbackController","metricsModel","domStorage","timelineConverter","dashManifestModel","dashMetrics","streamProcessor","manifestModel","setup","resetInitialSettings","on","QUALITY_CHANGE_REQUESTED","onQualityChanged","REPRESENTATION_UPDATED","onRepresentationUpdated","WALLCLOCK_TIME_UPDATED","onWallclockTimeUpdated","BUFFER_LEVEL_UPDATED","onBufferLevelUpdated","MANIFEST_VALIDITY_CHANGED","onManifestValidityChanged","setConfig","config","initialize","getIndexHandler","getStreamProcessor","getData","getDataIndex","isUpdating","getCurrentRepresentation","reset","off","updateData","newRealAdaptation","voAdaptation","type","streamInfo","getStreamInfo","maxQuality","getTopQualityIndexFor","id","minIdx","getMinAllowedIndexFor","quality","averageThroughput","bitrate","trigger","DATA_UPDATE_STARTED","sender","updateRepresentations","FRAGMENTED_TEXT","getThroughputHistory","getAverageThroughput","getInitialBitrateFor","getQualityForBitrate","getMediaInfo","getQualityFor","undefined","getRepresentationForQuality","VIDEO","AUDIO","DATA_UPDATE_COMPLETED","data","currentRepresentation","i","length","updateRepresentation","addRepresentationSwitch","now","Date","currentVideoTimeMs","getTime","adaptation","addDVRMetric","manifestInfo","isDynamic","range","calcSegmentAvailabilityRange","addDVRInfo","getType","getQualityForRepresentation","voRepresentation","indexOf","isAllRepresentationsUpdated","ln","segmentInfoType","segmentAvailabilityRange","hasInitialization","SEGMENT_BASE","BASE_URL","segments","voReps","getIndexForAdaptation","period","mpd","manifest","index","getRepresentationsForAdaptation","updateAvailabilityWindow","resetAvailabilityWindow","forEach","rep","postponeUpdate","postponeTimePeriod","delay","update","AST_IN_FUTURE","setTimeout","e","r","representation","streamMetrics","getMetricsFor","STREAM","metrics","manifestUpdateInfo","getCurrentManifestUpdate","alreadyAdded","repInfo","err","repSwitch","DYNAMIC","ignorePostponeTimePeriod","segmentAvailabilityTimePeriod","end","start","liveDelay","computeLiveDelay","segmentDuration","DVRWindowSize","SEGMENTS_UPDATE_FAILED_ERROR_CODE","SEGMENTS_UPDATE_FAILED_ERROR_MESSAGE","error","representationInfo","mediaType","addManifestUpdateRepresentationInfo","presentationTimeOffset","startNumber","setPlaybackQuality","updateManifestUpdateInfo","latency","getCurrentRepresentationSwitch","getValue","doNotUpdateDVRWindowOnBufferUpdated","oldQuality","newQuality","isNaN","setSavedBitrateSettings","newDuration","duration","__dashjs_factory_name","getClassFactory"],"mappings":"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","file":"RepresentationController.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\nimport Constants from '../../streaming/constants/Constants';\r\nimport Errors from '../../core/errors/Errors';\r\nimport DashConstants from '../constants/DashConstants';\r\nimport DashJSError from '../../streaming/vo/DashJSError';\r\nimport EventBus from '../../core/EventBus';\r\nimport Events from '../../core/events/Events';\r\nimport FactoryMaker from '../../core/FactoryMaker';\r\nimport Representation from '../vo/Representation';\r\n\r\nfunction RepresentationController() {\r\n\r\n    let context = this.context;\r\n    let eventBus = EventBus(context).getInstance();\r\n\r\n    let instance,\r\n        realAdaptation,\r\n        realAdaptationIndex,\r\n        updating,\r\n        voAvailableRepresentations,\r\n        currentVoRepresentation,\r\n        abrController,\r\n        indexHandler,\r\n        playbackController,\r\n        metricsModel,\r\n        domStorage,\r\n        timelineConverter,\r\n        dashManifestModel,\r\n        dashMetrics,\r\n        streamProcessor,\r\n        manifestModel;\r\n\r\n    function setup() {\r\n        resetInitialSettings();\r\n\r\n        eventBus.on(Events.QUALITY_CHANGE_REQUESTED, onQualityChanged, instance);\r\n        eventBus.on(Events.REPRESENTATION_UPDATED, onRepresentationUpdated, instance);\r\n        eventBus.on(Events.WALLCLOCK_TIME_UPDATED, onWallclockTimeUpdated, instance);\r\n        eventBus.on(Events.BUFFER_LEVEL_UPDATED, onBufferLevelUpdated, instance);\r\n        eventBus.on(Events.MANIFEST_VALIDITY_CHANGED, onManifestValidityChanged, instance);\r\n    }\r\n\r\n    function setConfig(config) {\r\n        // allow the abrController created in setup to be overidden\r\n        if (config.abrController) {\r\n            abrController = config.abrController;\r\n        }\r\n        if (config.domStorage) {\r\n            domStorage = config.domStorage;\r\n        }\r\n        if (config.metricsModel) {\r\n            metricsModel = config.metricsModel;\r\n        }\r\n        if (config.dashMetrics) {\r\n            dashMetrics = config.dashMetrics;\r\n        }\r\n        if (config.dashManifestModel) {\r\n            dashManifestModel = config.dashManifestModel;\r\n        }\r\n        if (config.playbackController) {\r\n            playbackController = config.playbackController;\r\n        }\r\n        if (config.timelineConverter) {\r\n            timelineConverter = config.timelineConverter;\r\n        }\r\n        if (config.manifestModel) {\r\n            manifestModel = config.manifestModel;\r\n        }\r\n        if (config.streamProcessor) {\r\n            streamProcessor = config.streamProcessor;\r\n        }\r\n    }\r\n\r\n    function initialize() {\r\n        indexHandler = streamProcessor.getIndexHandler();\r\n    }\r\n\r\n    function getStreamProcessor() {\r\n        return streamProcessor;\r\n    }\r\n\r\n    function getData() {\r\n        return realAdaptation;\r\n    }\r\n\r\n    function getDataIndex() {\r\n        return realAdaptationIndex;\r\n    }\r\n\r\n    function isUpdating() {\r\n        return updating;\r\n    }\r\n\r\n    function getCurrentRepresentation() {\r\n        return currentVoRepresentation;\r\n    }\r\n\r\n    function resetInitialSettings() {\r\n        realAdaptation = null;\r\n        realAdaptationIndex = -1;\r\n        updating = true;\r\n        voAvailableRepresentations = [];\r\n        abrController = null;\r\n        playbackController = null;\r\n        metricsModel = null;\r\n        domStorage = null;\r\n        timelineConverter = null;\r\n        dashManifestModel = null;\r\n        dashMetrics = null;\r\n    }\r\n\r\n    function reset() {\r\n\r\n        eventBus.off(Events.QUALITY_CHANGE_REQUESTED, onQualityChanged, instance);\r\n        eventBus.off(Events.REPRESENTATION_UPDATED, onRepresentationUpdated, instance);\r\n        eventBus.off(Events.WALLCLOCK_TIME_UPDATED, onWallclockTimeUpdated, instance);\r\n        eventBus.off(Events.BUFFER_LEVEL_UPDATED, onBufferLevelUpdated, instance);\r\n        eventBus.off(Events.MANIFEST_VALIDITY_CHANGED, onManifestValidityChanged, instance);\r\n\r\n        resetInitialSettings();\r\n    }\r\n\r\n    function updateData(newRealAdaptation, voAdaptation, type) {\r\n        const streamInfo = streamProcessor.getStreamInfo();\r\n        const maxQuality = abrController.getTopQualityIndexFor(type, streamInfo.id);\r\n        const minIdx = abrController.getMinAllowedIndexFor(type);\r\n\r\n        let quality,\r\n            averageThroughput;\r\n        let bitrate = null;\r\n\r\n        updating = true;\r\n        eventBus.trigger(Events.DATA_UPDATE_STARTED, {sender: this});\r\n\r\n        voAvailableRepresentations = updateRepresentations(voAdaptation);\r\n\r\n        if ((realAdaptation === null || (realAdaptation.id != newRealAdaptation.id)) && type !== Constants.FRAGMENTED_TEXT) {\r\n            averageThroughput = abrController.getThroughputHistory().getAverageThroughput(type);\r\n            bitrate = averageThroughput || abrController.getInitialBitrateFor(type, streamInfo);\r\n            quality = abrController.getQualityForBitrate(streamProcessor.getMediaInfo(), bitrate);\r\n        } else {\r\n            quality = abrController.getQualityFor(type, streamInfo);\r\n        }\r\n\r\n        if (minIdx !== undefined && quality < minIdx) {\r\n            quality = minIdx;\r\n        }\r\n        if (quality > maxQuality) {\r\n            quality = maxQuality;\r\n        }\r\n\r\n        currentVoRepresentation = getRepresentationForQuality(quality);\r\n        realAdaptation = newRealAdaptation;\r\n\r\n        if (type !== Constants.VIDEO && type !== Constants.AUDIO && type !== Constants.FRAGMENTED_TEXT) {\r\n            updating = false;\r\n            eventBus.trigger(Events.DATA_UPDATE_COMPLETED, {sender: this, data: realAdaptation, currentRepresentation: currentVoRepresentation});\r\n            return;\r\n        }\r\n\r\n        for (let i = 0; i < voAvailableRepresentations.length; i++) {\r\n            indexHandler.updateRepresentation(voAvailableRepresentations[i], true);\r\n        }\r\n    }\r\n\r\n    function addRepresentationSwitch() {\r\n        const now = new Date();\r\n        const currentRepresentation = getCurrentRepresentation();\r\n        const currentVideoTimeMs = playbackController.getTime() * 1000;\r\n\r\n        metricsModel.addRepresentationSwitch(currentRepresentation.adaptation.type, now, currentVideoTimeMs, currentRepresentation.id);\r\n    }\r\n\r\n    function addDVRMetric() {\r\n        const streamInfo = streamProcessor.getStreamInfo();\r\n        const manifestInfo = streamInfo ? streamInfo.manifestInfo : null;\r\n        const isDynamic = manifestInfo ? manifestInfo.isDynamic : null;\r\n        const range = timelineConverter.calcSegmentAvailabilityRange(currentVoRepresentation, isDynamic);\r\n        metricsModel.addDVRInfo(streamProcessor.getType(), playbackController.getTime(), manifestInfo, range);\r\n    }\r\n\r\n    function getRepresentationForQuality(quality) {\r\n        return quality === null || quality === undefined || quality >= voAvailableRepresentations.length ? null : voAvailableRepresentations[quality];\r\n    }\r\n\r\n    function getQualityForRepresentation(voRepresentation) {\r\n        return voAvailableRepresentations.indexOf(voRepresentation);\r\n    }\r\n\r\n    function isAllRepresentationsUpdated() {\r\n        for (let i = 0, ln = voAvailableRepresentations.length; i < ln; i++) {\r\n            let segmentInfoType = voAvailableRepresentations[i].segmentInfoType;\r\n            if (voAvailableRepresentations[i].segmentAvailabilityRange === null || !Representation.hasInitialization(voAvailableRepresentations[i]) ||\r\n                ((segmentInfoType === DashConstants.SEGMENT_BASE || segmentInfoType === DashConstants.BASE_URL) && !voAvailableRepresentations[i].segments)\r\n            ) {\r\n                return false;\r\n            }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    function updateRepresentations(voAdaptation) {\r\n        let voReps;\r\n\r\n        realAdaptationIndex = dashManifestModel.getIndexForAdaptation(realAdaptation, voAdaptation.period.mpd.manifest, voAdaptation.period.index);\r\n        voReps = dashManifestModel.getRepresentationsForAdaptation(voAdaptation);\r\n\r\n        return voReps;\r\n    }\r\n\r\n    function updateAvailabilityWindow(isDynamic) {\r\n        let voRepresentation;\r\n\r\n        for (let i = 0, ln = voAvailableRepresentations.length; i < ln; i++) {\r\n            voRepresentation = voAvailableRepresentations[i];\r\n            voRepresentation.segmentAvailabilityRange = timelineConverter.calcSegmentAvailabilityRange(voRepresentation, isDynamic);\r\n        }\r\n    }\r\n\r\n    function resetAvailabilityWindow() {\r\n        voAvailableRepresentations.forEach(rep => {\r\n            rep.segmentAvailabilityRange = null;\r\n        });\r\n    }\r\n\r\n    function postponeUpdate(postponeTimePeriod) {\r\n        let delay = postponeTimePeriod;\r\n        let update = function () {\r\n            if (isUpdating()) return;\r\n\r\n            updating = true;\r\n            eventBus.trigger(Events.DATA_UPDATE_STARTED, { sender: instance });\r\n\r\n            // clear the segmentAvailabilityRange for all reps.\r\n            // this ensures all are updated before the live edge search starts\r\n            resetAvailabilityWindow();\r\n\r\n            for (let i = 0; i < voAvailableRepresentations.length; i++) {\r\n                indexHandler.updateRepresentation(voAvailableRepresentations[i], true);\r\n            }\r\n        };\r\n\r\n        updating = false;\r\n        eventBus.trigger(Events.AST_IN_FUTURE, { delay: delay });\r\n        setTimeout(update, delay);\r\n    }\r\n\r\n    function onRepresentationUpdated(e) {\r\n        if (e.sender.getStreamProcessor() !== streamProcessor || !isUpdating()) return;\r\n\r\n        let r = e.representation;\r\n        let streamMetrics = metricsModel.getMetricsFor(Constants.STREAM);\r\n        var metrics = metricsModel.getMetricsFor(getCurrentRepresentation().adaptation.type);\r\n        let manifestUpdateInfo = dashMetrics.getCurrentManifestUpdate(streamMetrics);\r\n        let alreadyAdded = false;\r\n        let postponeTimePeriod = 0;\r\n        let repInfo,\r\n            err,\r\n            repSwitch;\r\n\r\n        if (r.adaptation.period.mpd.manifest.type === DashConstants.DYNAMIC && !r.adaptation.period.mpd.manifest.ignorePostponeTimePeriod)\r\n        {\r\n            let segmentAvailabilityTimePeriod = r.segmentAvailabilityRange.end - r.segmentAvailabilityRange.start;\r\n            // We must put things to sleep unless till e.g. the startTime calculation in ScheduleController.onLiveEdgeSearchCompleted fall after the segmentAvailabilityRange.start\r\n            let liveDelay = playbackController.computeLiveDelay(currentVoRepresentation.segmentDuration, streamProcessor.getStreamInfo().manifestInfo.DVRWindowSize);\r\n            postponeTimePeriod = (liveDelay - segmentAvailabilityTimePeriod) * 1000;\r\n        }\r\n\r\n        if (postponeTimePeriod > 0) {\r\n            addDVRMetric();\r\n            postponeUpdate(postponeTimePeriod);\r\n            err = new DashJSError(Errors.SEGMENTS_UPDATE_FAILED_ERROR_CODE, Errors.SEGMENTS_UPDATE_FAILED_ERROR_MESSAGE);\r\n            eventBus.trigger(Events.DATA_UPDATE_COMPLETED, {sender: this, data: realAdaptation, currentRepresentation: currentVoRepresentation, error: err});\r\n\r\n            return;\r\n        }\r\n\r\n        if (manifestUpdateInfo) {\r\n            for (let i = 0; i < manifestUpdateInfo.representationInfo.length; i++) {\r\n                repInfo = manifestUpdateInfo.representationInfo[i];\r\n                if (repInfo.index === r.index && repInfo.mediaType === streamProcessor.getType()) {\r\n                    alreadyAdded = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (!alreadyAdded) {\r\n                metricsModel.addManifestUpdateRepresentationInfo(manifestUpdateInfo, r.id, r.index, r.adaptation.period.index,\r\n                        streamProcessor.getType(),r.presentationTimeOffset, r.startNumber, r.segmentInfoType);\r\n            }\r\n        }\r\n\r\n        if (isAllRepresentationsUpdated()) {\r\n            updating = false;\r\n            abrController.setPlaybackQuality(streamProcessor.getType(), streamProcessor.getStreamInfo(), getQualityForRepresentation(currentVoRepresentation));\r\n            metricsModel.updateManifestUpdateInfo(manifestUpdateInfo, {latency: currentVoRepresentation.segmentAvailabilityRange.end - playbackController.getTime()});\r\n\r\n            repSwitch = dashMetrics.getCurrentRepresentationSwitch(metrics);\r\n\r\n            if (!repSwitch) {\r\n                addRepresentationSwitch();\r\n            }\r\n\r\n            eventBus.trigger(Events.DATA_UPDATE_COMPLETED, {sender: this, data: realAdaptation, currentRepresentation: currentVoRepresentation});\r\n        }\r\n    }\r\n\r\n    function onWallclockTimeUpdated(e) {\r\n        if (e.isDynamic) {\r\n            updateAvailabilityWindow(e.isDynamic);\r\n        }\r\n    }\r\n\r\n    function onBufferLevelUpdated(e) {\r\n        if (e.sender.getStreamProcessor() !== streamProcessor) return;\r\n        let manifest = manifestModel.getValue();\r\n        if (!manifest.doNotUpdateDVRWindowOnBufferUpdated) {\r\n            addDVRMetric();\r\n        }\r\n    }\r\n\r\n    function onQualityChanged(e) {\r\n        if (e.mediaType !== streamProcessor.getType() || streamProcessor.getStreamInfo().id !== e.streamInfo.id) return;\r\n\r\n        if (e.oldQuality !== e.newQuality) {\r\n            currentVoRepresentation = getRepresentationForQuality(e.newQuality);\r\n            const bitrate = abrController.getThroughputHistory().getAverageThroughput(e.mediaType);\r\n            if (!isNaN(bitrate)) {\r\n                domStorage.setSavedBitrateSettings(e.mediaType, bitrate);\r\n            }\r\n            addRepresentationSwitch();\r\n        }\r\n    }\r\n\r\n    function onManifestValidityChanged(e) {\r\n        if (e.newDuration) {\r\n            const representation = getCurrentRepresentation();\r\n            if (representation && representation.adaptation.period) {\r\n                const period = representation.adaptation.period;\r\n                period.duration = e.newDuration;\r\n            }\r\n        }\r\n    }\r\n\r\n    instance = {\r\n        initialize: initialize,\r\n        setConfig: setConfig,\r\n        getData: getData,\r\n        getDataIndex: getDataIndex,\r\n        isUpdating: isUpdating,\r\n        updateData: updateData,\r\n        getStreamProcessor: getStreamProcessor,\r\n        getCurrentRepresentation: getCurrentRepresentation,\r\n        getRepresentationForQuality: getRepresentationForQuality,\r\n        reset: reset\r\n    };\r\n\r\n    setup();\r\n    return instance;\r\n}\r\n\r\nRepresentationController.__dashjs_factory_name = 'RepresentationController';\r\nexport default FactoryMaker.getClassFactory(RepresentationController);\r\n"]}